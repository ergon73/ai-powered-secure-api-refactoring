# Refactoring Audit

## Итог
- Архитектура стала чище (factory + blueprints, параметризованные запросы), но в репозитории остались уязвимые модули и несоответствия документации. В текущем виде проект нельзя считать завершенным рефакторингом или полностью безопасным.

## Ключевые замечания
- Наследованный уязвимый код оставлен без пометок и может быть случайно запущен: `api.py:16-31` и `utils.py:10-59` содержат SQL-инъекции, небезопасное «хеширование» паролей (просто реверс), незакрытые ресурсы и гонки потоков. README/REFACTORING_REPORT заявляют об устранении уязвимостей, но эти файлы остаются в рабочем дереве и не исключены из образа.
- Безопасность паролей не внедрена в основной поток: таблица `users` содержит `password_hash`, но эндпоинты не принимают пароли, функции `app/security.py:10-38` нигде не вызываются, а в `utils.py:26-33` все еще используется небезопасное сохранение. Заявление о «PBKDF2» в отчете вводит в заблуждение.
- Валидация и обработка ошибок неполные: `app/routes.py:38-42` глотает любые исключения и возвращает обезличенный 500 без логирования, `app/routes.py:56-61` не ловит ошибки БД, OpenAPI не описывает возможные 500 для GET. Нет ограничений на длину имени и защит от слишком больших тел/невалидного JSON.
- Претензии на «100% type hints / PEP 8» не соблюдаются: `api.py` и `utils.py` по-прежнему без аннотаций и стиля, остаются частью репозитория.
- Операционные пробелы: жестко заданный путь БД `app/database.py:12` и `check_same_thread=False` без необходимости; `init_db` дергается при каждом старте воркера Gunicorn; отсутствуют миграции и какие-либо тесты при заявленной «production-ready» готовности.

## Позитивные моменты
- Основные маршруты вынесены в `app/routes.py`, бизнес-логика и доступ к БД — в `app/services.py`, что устраняет инъекции в новой реализации.
- Dockerfile использует `python:3.11-slim`, переключает пользователя на non-root и запускает Gunicorn.

## Рекомендации
1. Удалить или четко архивировать/исключить `api.py` и `utils.py` из сборок; переписать их в безопасном виде или удалить.
2. Либо реализовать полноценный сценарий с паролями (hash/verify + схемы запросов), либо убрать колонку `password_hash` и упоминания о PBKDF2 из документации.
3. Унифицировать валидацию и ошибки: проверять JSON/длину, возвращать согласованный формат ошибок, логировать исключения; обновить `openapi.yaml`.
4. Вынести конфигурацию (путь БД, DEBUG, SECRET_KEY) в переменные окружения, добавить миграции и минимальные автоматические тесты.
5. Синхронизировать README/REFACTORING_REPORT с реальным состоянием или довести код до заявленного уровня, чтобы избежать ложного ощущения безопасности.
